<!doctype html>
<html>
  <head>
    <title>Occupancy</title>
    <script src="app.js"></script>
    <link rel="stylesheet" href="styles.css">

  </head>
  <body>
    <div id="titleBlock">
    <h1 id="heading">STEM Collab Room Occupancy Status</h1>
    </div>

    <div id="basementER-div" class="roomDiv">
    <h2>Basement Elevator Room</h2>
    <h3 id="basementER" class="statusDisplay"></h3>
    <button id="basementER-button" onclick="updateText('basementER-button')"></button>
    </div>

    <div id="1ER-div" class="roomDiv">
    <h2>First Floor Elevator Room</h2>
    <h3 id="1ER" class="statusDisplay"></h3>
    <button id="1ER-button" onclick="updateText('1ER-button')"></button>
    </div>
  
    <div id="2ER-div" class="roomDiv">
    <h2>Second Floor Elevator Room</h2>
    <h3 id="2ER" class="statusDisplay"></h3>
    <button id="2ER-button" onclick="updateText('2ER-button')"></button>
    </div>
    

    <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-firestore.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyA7qQpzU6xPQyJa-kLGNnmOFuOFZxCEmNk",
    authDomain: "occupation-1f04d.firebaseapp.com",
    databaseURL: "https://occupation-1f04d.firebaseio.com",
    projectId: "occupation-1f04d",
    storageBucket: "occupation-1f04d.appspot.com",
    messagingSenderId: "661455757520",
    appId: "1:661455757520:web:9b368da7d8012b2519bed5",
    measurementId: "G-RLHK6DTRGE"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  //creates an array of all the room displays on loading of page and then calls on applyLoad function
  window.onload = function ()
  {
    var statusDisplays = document.getElementsByClassName("statusDisplay");
  
    for (var i=0;i<statusDisplays.length;i++)
    {
      applyLoad(statusDisplays[i]);
     
    }
  }

  //gets data from getRawStatus (which reads from database) to update display
  function applyLoad (statusDisplay)
  {
    getRawStatus(statusDisplay.id).then(function(statusVar)
    {
      var roomStatusVar = roomStatus(statusVar);
      var buttonTextVar = buttonText(statusVar);
      statusDisplay.innerHTML=roomStatusVar;
      var buttonID = statusDisplay.id + "-button";
      document.getElementById(buttonID).innerHTML=buttonTextVar;

      if(statusVar == 1)
      {
       remainingTime(statusDisplay);
       document.getElementById(statusDisplay.id).style.color="red"; //changes color to red
      }
      else
        document.getElementById(statusDisplay.id).style.color="green"; //changes color to green
    })
  }

  //calculates occupancy time remaining, and displays it, and updates status if occupancy is done
  function remainingTime (statusDisplay)
  {
    var currentDate = new Date();
    var currentTime = currentDate.getTime();

    getInputTime(statusDisplay.id)
    .then(function(inputTime)
    {
      getOccupyTime(statusDisplay.id)
      .then(function(occupyTime)
      {
        var msOccupyTime = occupyTime*60000;
        var diff = currentTime - inputTime;

        if(diff >= msOccupyTime)
        {
          updateText(statusDisplay.id + "-button");
        }
        else 
        {
          var timeRemaining = document.createElement("p");
          var timeText = document.createTextNode(Math.round((msOccupyTime-diff)/60000) + " minutes remaining");
          var div = document.getElementById(statusDisplay.id + "-div");
          timeRemaining.id=statusDisplay.id + "-p";

          timeRemaining.appendChild(timeText);
          div.appendChild(timeRemaining);
          div.style.color="red";
        }
      })
    })
  }
  
  
  //function that converts database 0,1 value into roomStatus as a string 
  function roomStatus (rawStatus)
  {
    if (rawStatus == 0)
      return "Currently Vacant";
    else 
      return "Currently Occupied";
  }
  
  //function that converts database 0,1 value into buttonText as a string
  function buttonText (rawStatus)
  {
    if (rawStatus == 0)
      return "Occupy this room!";
    else 
      return "Vacate this room!";
  }
  
  //function switches numbers (used to change numbers for database, everytime a button is hit)
  function change (num)
  {
    if (num == 0)
      return 1;
    else
      return 0;
      
  }

  function checkFormExist(room)
  {
   if(document.body.contains(document.getElementById("timeForm-" + room)))
    return true;
   else
    return false;
  }
  
  //changes room status to opposite whatever it is right now
  function updateText(buttonID)
  {
    //getting roomID after slicing button ID (button ID must always be "room" + "-" + "buttonID"
    var pos = buttonID.indexOf("-");
    var room = buttonID.slice(0,pos);
  
  
    getRawStatus(room)
      .then(function(statusVar) {
  
        var changedStatusVar = change(statusVar);//status changed to what the new one will be
        var roomStatusVar = roomStatus(changedStatusVar);
        var buttonTextVar = buttonText(changedStatusVar);
  
      
        //if the roomStatus is being changed to occupied (1), then form is created
        var timeInput = -1;
        if(changedStatusVar==1)
        {
          if(checkFormExist(room) == false)
          {
            var form = document.createElement("form");
            form.id="timeForm-" + room;
            form.name="form-" + room;

            var br = document.createElement("BR");
            var label = document.createElement("label");
            var labelText = document.createTextNode("Time that you are going to be in the room for (in minutes): ")
            var div = document.getElementById(room + "-div");
            var input1= document.createElement("input");
            input1.name="inputText";
            input1.type="number";
            input1.min="15";
            input1.max="90";

            var inputSubmit = document.createElement("button");
            //inputSubmit.type="button";
            inputSubmit.type="submit";
            var submitText = document.createTextNode("Submit!");
            
            inputSubmit.id="submitButton";
            //inputSubmit.onclick=checkNothing(room);
                  
            form.appendChild(br);
            inputSubmit.appendChild(submitText);
            label.appendChild(labelText);
            form.appendChild(label);
            form.appendChild(input1);
            form.appendChild(inputSubmit);
            div.appendChild(form);

            //when form submitted
            form.addEventListener('submit', function(e){
              e.preventDefault(); //prevents refresh
              var inputDate = new Date();

              timeInput = form.inputText.value;

              if(timeInput == "")
              {
                alert("Type in a valid number of minutes")
              }
              else
              {
                document.getElementById(room).innerHTML=roomStatusVar;//roomStatus on website updated
      
                document.getElementById(buttonID).innerHTML=buttonTextVar;//buttonText on website updated
            
                //database updated for new values
                db.collection("rooms").doc(room).set({
                status: changedStatusVar
                ,time: timeInput
                ,inputTime: inputDate.getTime() //this is the start time for when the room occupancy started
                })

                //form removed
                form.parentNode.removeChild(form);

                //sets remaining time 
                remainingTime(document.getElementById(room));

                //changes text color to red
                document.getElementById(room).style.color="red";
              }
            })
          }
          else //if the form already exists
          {
            alert("Enter the number of minutes that the room is going to be occupied for!");
          }
        }
        else //if the room is being made vacant (a form does not need to be created)
        {
          document.getElementById(room).innerHTML=roomStatusVar;//roomStatus on website updated
  
          document.getElementById(buttonID).innerHTML=buttonTextVar;//buttonText on website updated
        
          //database updated for new values
          db.collection("rooms").doc(room).set({
            status: changedStatusVar
          })
          
          //remove remaining time message
          document.getElementById(room + "-p").parentNode.removeChild(document.getElementById(room + "-p"));
          
          //change color to green
          document.getElementById(room).style.color="green";

        }
      })
    
  }//end updateText


  //current status value is pulled from database
  function getRawStatus (room)
  {
    return db.collection("rooms").doc(room).get().then(function(doc) {
      return doc.data().status;
    });
  }

  function getOccupyTime (room)
  {
    return db.collection("rooms").doc(room).get().then(function(doc) {
      return doc.data().time;
    });
  }

  function getInputTime (room)
  {
    return db.collection("rooms").doc(room).get().then(function(doc) {
      return doc.data().inputTime;
    });
  }

</script>

  </body>
</html>
